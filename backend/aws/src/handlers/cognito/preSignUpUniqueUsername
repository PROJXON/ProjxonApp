// Cognito Trigger: Pre sign-up
// Purpose: enforce username rules and (optionally) enforce case-insensitive uniqueness via USERS_TABLE.
//
// Env (optional but recommended):
// - USERS_TABLE: DynamoDB table keyed by userSub, with GSI byUsernameLower (PK usernameLower)

const { DynamoDBClient } = require('@aws-sdk/client-dynamodb');
const { DynamoDBDocumentClient, QueryCommand } = require('@aws-sdk/lib-dynamodb');

const ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));

exports.handler = async (event) => {
  const attrs = event.request.userAttributes || {};
  const preferred = attrs.preferred_username;
  const MAX_USERNAME_LEN = 21;

  if (!preferred) {
    throw new Error('Username (preferred_username) is required.');
  }

  // Enforce a reasonable username length (Cognito allows much longer).
  if (String(preferred).length > MAX_USERNAME_LEN) {
    throw new Error(`Username must be ${MAX_USERNAME_LEN} characters or fewer.`);
  }

  // Reject ANY whitespace (so "Name ", "Name  ", "Hot Dog" all fail)
  if (/\s/.test(preferred)) {
    throw new Error('Username cannot contain spaces.');
  }

  // Reject commas, backslash, forward slash, apostrophe, #, and double-quote
  if (/[,\\/"'#]/.test(preferred)) {
    throw new Error(`Username cannot contain commas, /, \\, ', #, or ".`);
  }

  // Optional (recommended): enforce case-insensitive uniqueness via Users table.
  // This is the only reliable way to prevent "John" and "john" as separate users.
  const usersTable = process.env.USERS_TABLE;
  if (usersTable) {
    const usernameLower = String(preferred).trim().toLowerCase();
    const resp = await ddb.send(
      new QueryCommand({
        TableName: usersTable,
        IndexName: 'byUsernameLower',
        KeyConditionExpression: 'usernameLower = :u',
        ExpressionAttributeValues: { ':u': usernameLower },
        Limit: 1,
      })
    );
    if (resp.Items && resp.Items.length > 0) {
      throw new Error('Username is already taken.');
    }
  }
  
  // Optional: auto-confirm and auto-verify email if provided
  event.response.autoConfirmUser = true;
  if (attrs.email) event.response.autoVerifyEmail = true;

  return event;
};